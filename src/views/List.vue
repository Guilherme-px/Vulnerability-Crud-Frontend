<template>
    <section class="table">
        <ModalFormMessage
            :snackbar.sync="$store.state.snackbar"
            :message="$store.state.msgNoChangeEdit"
            :color="$store.state.color"
            :titleMessage="''"
        />
        <v-card dark class="table__card">
            <v-card-title class="table__card--title">
                Lista de vulnerabilidades
                <v-spacer></v-spacer>
                <v-text-field
                    append-icon="mdi-magnify"
                    v-model="search"
                    label="Digite o nome ou o grau de criticidade"
                    single-line
                    hide-details
                    @click:append="searchVulnerabilities"
                    @keyup.enter="searchVulnerabilities"
                >
                </v-text-field>
            </v-card-title>
            <v-data-table
                :server-items-length="totalPages"
                :headers="headers"
                :items-per-page="1"
                :items="vulnerabilities"
                :page.sync="page"
                @pagination="pagination"
            >
                <template v-slot:top>
                    <v-dialog v-model="dialogDelete" max-width="500px">
                        <v-card>
                            <v-card-title class="text-h5 text-center">
                                Você está prestes a excluir a vulnerabilidade
                                {{ id.title }}. Deseja continuar?</v-card-title
                            >
                            <v-card-actions>
                                <v-spacer></v-spacer>
                                <v-btn
                                    color="blue darken-1"
                                    text
                                    @click="closeDelete"
                                    >Não</v-btn
                                >
                                <v-btn
                                    color="blue darken-1"
                                    text
                                    @click="deleteItemConfirm"
                                    >Sim</v-btn
                                >
                                <v-spacer></v-spacer>
                            </v-card-actions>
                        </v-card>
                    </v-dialog>
                </template>
                <template v-slot:[`item.actions`]="{ item }">
                    <v-icon
                        small
                        class="mr-2"
                        @click="
                            $router.push({
                                name: 'Edit',
                                params: { id: item._id },
                            })
                        "
                    >
                        mdi-pencil
                    </v-icon>
                    <v-icon small @click="deleteItem(item)">
                        mdi-delete
                    </v-icon>
                </template>
                <template v-slot:no-data>
                    <v-btn color="primary"> Reset </v-btn>
                </template>
            </v-data-table>
        </v-card>
    </section>
</template>

<script>
    import axios from '@/utils/axios';
    import ModalFormMessage from '../components/forms/ModalFormMessage.vue';

    export default {
        components: { ModalFormMessage },
        name: 'List',
        data: () => ({
            snackbar: false,
            next: 0,
            color: '',
            message: '',
            search: '',
            page: 1,
            dialogDelete: false,
            headers: [
                { text: 'Titulo', value: 'title' },
                { text: 'Descrição', value: 'description', filterable: false },
                {
                    text: 'Grau de criticidade',
                    value: 'criticality',
                },
                {
                    text: ' Tipo de vulnerabilidade',
                    value: 'vulnerability',
                    filterable: false,
                },
                {
                    text: 'Solução proposta',
                    value: 'solution',
                    filterable: false,
                },
                { text: 'Actions', value: 'actions', sortable: false },
            ],
            vulnerabilities: [],
            totalPages: 0,
            id: {},
        }),
        methods: {
            // load the list of vulnerabilities
            getAllVulnerabilities() {
                axios
                    .get(
                        `/vulnerability?search=${this.search}&page=${this.page}`
                    )
                    .then((res) => {
                        this.vulnerabilities = res.data.vulnerabilities;
                        this.totalPages = res.data.totalPages;
                    });
            },

            // pagination method
            pagination() {
                // if next is greater than 1 the route is replaced by the route with query params
                if (this.next > 1) {
                    this.getAllVulnerabilities();
                    this.$router.replace({ query: { page: this.page } });
                } else {
                    // if the route is less than 1 next gets + 1
                    this.next++;
                }
            },

            // search method
            searchVulnerabilities() {
                //when it calls it calls the getAllVulnerabilities method and replaces the route by adding query params
                this.getAllVulnerabilities();
                if (this.search.length > 0) {
                    this.$router.replace({ query: { search: this.search } });
                }
            },

            // open the delete modal and assign the selected item to id
            deleteItem(item) {
                this.id = item;
                this.dialogDelete = true;
            },

            // delete the selected vulnerability and close the modal
            deleteItemConfirm() {
                axios.delete(`/vulnerability/${this.id._id}`).then(() => {
                    this.closeDelete();
                    this.getAllVulnerabilities();
                });
            },

            // close delete modal when called
            closeDelete() {
                this.dialogDelete = false;
            },
        },
        watch: {
            dialogDelete(val) {
                val || this.closeDelete();
            },
        },
        mounted() {
            this.getAllVulnerabilities();
        },
    };
</script>

<style lang="sass">
    .table
        margin: 30px
        .table__card
            padding: 30px
            .table__card--title
                margin: 0 0 60px

    .v-card__title
        word-break: break-word !important
</style>
