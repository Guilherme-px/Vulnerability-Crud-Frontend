<template>
    <div class="form">
        <v-flex xs10 sm8 md6 lg5>
            <v-card dark>
                <FormTitle title="Editar" />
                <ModalFormMessage
                    :snackbar.sync="snackbar"
                    :message="message"
                    :color="color"
                />
                <v-form ref="form" class="d-flex flex-column">
                    <FormInputs
                        v-model="vulnerabilities.title"
                        label="Título"
                        :change="change"
                    />
                    <FormInputs
                        v-model="vulnerabilities.description"
                        label="Descrição"
                        :change="change"
                    />
                    <v-select
                        label="Grau de criticidade"
                        @change="change(vulnerabilities.criticality)"
                        v-model="vulnerabilities.criticality"
                        :items="items.criticality"
                    ></v-select>
                    <v-select
                        label="Tipo de vulnerabilidade"
                        @change="change(vulnerabilities.vulnerability)"
                        v-model="vulnerabilities.vulnerability"
                        :items="items.vulnerability"
                    ></v-select>
                    <img
                        v-if="vulnerabilities.evidence !== undefined"
                        :src="imageUrl + vulnerabilities.evidence"
                        alt=""
                    />
                    <v-file-input @change="onselect"></v-file-input>
                    <FormInputs
                        v-model="vulnerabilities.solution"
                        label="Solução proposta"
                        :change="change"
                    />
                    <FormBtns :handleSubmit="modalEdit" :goBack="goBack" />
                    <Dialog
                        :dialog.sync="dialogEdit"
                        warning="Tem certeza que deseja alterar o registro?"
                        :handleNot="close"
                        :handleYes="update"
                    />
                    <Dialog
                        :dialog.sync="dialogEditBack"
                        warning="Você está saindo da edição sem salvar os dados. Deseja continuar?"
                        :handleNot="close"
                        :handleYes="backList"
                    />
                </v-form>
            </v-card>
        </v-flex>
    </div>
</template>

<script>
    import Dialog from '../components/forms/Dialog.vue';
    import FormBtns from '../components/forms/FormBtns.vue';
    import FormInputs from '../components/forms/FormInputs.vue';
    import FormTitle from '../components/forms/FormTitle.vue';
    import ModalFormMessage from '../components/forms/ModalFormMessage.vue';

    import axios from '../utils/axios';

    export default {
        name: 'Edit',
        components: {
            FormTitle,
            ModalFormMessage,
            FormInputs,
            FormBtns,
            Dialog,
        },
        data: () => ({
            snackbar: false,
            color: '',
            message: '',
            vulnerabilities: {},
            dialogEditBack: false,
            items: {
                criticality: ['low', 'min', 'high'],
                vulnerability: ['DAST', 'SAST', 'NETWORK'],
            },
            imageFile: null,
            imageUrl: null,
            IsChanged: Boolean,
            dialogEdit: false,
        }),
        props: {
            id: {},
        },
        methods: {
            // detects event in the file field and assigns the event result to the evidence field
            onselect(e) {
                this.vulnerabilities.evidence = e;
                this.IsChanged = true;
            },
            // detect event in select fields and set true to IsChanged
            change(e) {
                e;
                this.IsChanged = true;
            },
            // method to update vulnerabilities
            async update() {
                // assign formdata to fd
                const fd = new FormData();

                // loop through vulnerabilities keys
                await Object.keys(this.vulnerabilities).forEach((key) => {
                    // separate image file from other fields
                    if (key === 'evidence') {
                        fd.append('evidence', this.vulnerabilities[key]);
                    } else {
                        fd.append(key, this.vulnerabilities[key]);
                    }
                });

                // call the API
                await axios
                    .patch(`/vulnerability/${this.$route.params.id}`, fd, {
                        headers: {
                            'Content-Type': 'multipart/form-data',
                        },
                    })
                    .then(() => {
                        // if any field has been changed, a message is sent
                        if (this.IsChanged === true) {
                            this.IsChanged = false;
                            this.dialogEdit = false;
                            this.color = 'success';
                            this.message = 'Operação concluída';
                            this.snackbar = true;
                        } else {
                            // if nothing has been changed another message is sent and the user is redirected to /list
                            this.$store.commit(
                                'showMessage',
                                'Nenhum dado foi alterado'
                            );
                            this.$router.push({
                                name: 'List',
                            });
                        }
                    })
                    // if an error occurs, the message from the api is displayed
                    .catch((e) => {
                        this.color = 'error';
                        this.message = e.response.data;
                        this.snackbar = true;
                        this.dialogEdit = false;
                    });
            },
            // load the vulnerabilities list
            async loadVulnerabilities() {
                await axios
                    .get(`/vulnerability/${this.$route.params.id}`)
                    .then((res) => {
                        this.vulnerabilities = res.data.vulnerabilities;
                    });
            },
            // open the alert modal
            modalEdit() {
                // if something has been changed the modal is opened
                if (this.IsChanged === true) {
                    this.dialogEdit = true;
                } else {
                    // otherwise, the update method is called
                    this.update();
                }
            },
            // back to list screen
            goBack() {
                // if something has been changed the modal is opened
                if (this.IsChanged === true) {
                    this.dialogEditBack = true;
                } else {
                    // if nothing has been changed the user is redirected
                    this.$router.push({
                        name: 'List',
                    });
                }
            },
            // close modal and redirect
            backList() {
                this.$router.push({ name: 'List' });
            },
            // close modals
            close() {
                this.dialogEdit = false;
                this.dialogEditBack = false;
            },
        },
        mounted() {
            // call method loadVulnerabilities
            this.loadVulnerabilities();
            // load the images from the public folder of the api
            this.imageUrl = 'http://localhost:4000/images/evidence/';
        },
    };
</script>

<style lang="sass">
    .form
        display: flex
        justify-content: center
        align-items: center
        margin: 50px 0

    img
        width:  200px
        height: 150px
        margin: 0 auto
</style>
