<template>
    <div class="form">
        <v-flex xs10 sm8 md6 lg5>
            <v-card dark>
                <FormTitle title="Cadastro" />
                <ModalFormMessage
                    :snackbar.sync="snackbar"
                    :message="message"
                    :color="color"
                />
                <v-form ref="form" class="d-flex flex-column">
                    <FormInputs
                        v-model="vulnerabilities.title"
                        label="Título"
                    />
                    <FormInputs
                        v-model="vulnerabilities.description"
                        label="Descrição"
                    />
                    <v-select
                        label="Grau de criticidade"
                        v-model="vulnerabilities.criticality"
                        :items="items.criticality"
                    ></v-select>
                    <v-select
                        label="Tipo de vulnerabilidade"
                        v-model="vulnerabilities.vulnerability"
                        :items="items.vulnerability"
                    ></v-select>
                    <v-file-input @change="onselect"></v-file-input>
                    <FormInputs
                        v-model="vulnerabilities.solution"
                        label="Solução proposta"
                    />
                    <FormBtns :handleSubmit="register" :goBack="goList" />
                </v-form>
            </v-card>
        </v-flex>
    </div>
</template>

<script>
    import FormBtns from '../components/forms/FormBtns.vue';
    import FormInputs from '../components/forms/FormInputs.vue';
    import FormTitle from '../components/forms/FormTitle.vue';
    import ModalFormMessage from '../components/forms/ModalFormMessage.vue';

    import axios from '../utils/axios';

    export default {
        components: {
            FormTitle,
            ModalFormMessage,
            FormInputs,
            FormBtns,
        },
        name: 'Register',
        data: () => ({
            snackbar: false,
            vulnerabilities: {},
            message: '',
            color: '',
            items: {
                criticality: ['low', 'min', 'high'],
                vulnerability: ['DAST', 'SAST', 'NETWORK'],
            },
            imageFile: null,
        }),
        methods: {
            // detects event in the file field and assigns the event result to the evidence field
            onselect(e) {
                this.vulnerabilities.evidence = e;
            },
            // method to call vulnerability registration post route
            async register() {
                // assign formdata to fd
                const fd = new FormData();

                // loop through vulnerabilities keys
                await Object.keys(this.vulnerabilities).forEach((key) => {
                    if (key === 'evidence') {
                        fd.append('evidence', this.vulnerabilities[key]);
                    } else {
                        fd.append(key, this.vulnerabilities[key]);
                    }
                });

                await axios
                    .post('/vulnerability/register', fd, {
                        headers: {
                            'Content-Type': 'multipart/form-data',
                        },
                    })
                    .then(() => {
                        // if everything goes right vulnerabilities are reset
                        this.vulnerabilities = {};
                    })
                    .catch((e) => {
                        // if an error occurs, the error alert is displayed with the error message coming from the api
                        this.message = e.response.data;
                        this.color = 'error';
                        this.snackbar = true;
                    });
            },
            // go to list screen
            goList() {
                this.$router.push({
                    name: 'List',
                });
            },
        },
    };
</script>

<style lang="sass">
    .form
        display: flex
        justify-content: center
        align-items: center
        margin: 50px 0
</style>
